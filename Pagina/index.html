<!--

index
Interfaz web para el monitoreo en tiempo real de ubicaci칩n, telemetr칤a y alertas de emergencia.

Integrantes:
- 츼ngel Ernesto Rizo L칩pez
- Diego Alberto S치nchez Infante

Funcion:
Permite la visualizaci칩n de datos GPS, control remoto de actuadores (buzzer), gesti칩n de 
per칤metros seguros (geocercas) y recepci칩n de evidencia visual v칤a MQTT, actuando como
centro de mando para el cuidador del paciente.

-->

<!DOCTYPE html>
<html lang="es">

<head>

    <!-- Importes -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Seguridad ITL - Brazalete</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Formatos -->
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', sans-serif;
        }

        .dashboard-container {
            max-width: 1300px;
            margin: 20px auto;
        }

        #map {
            height: 500px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .card-custom {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .status-badge {
            font-size: 0.9rem;
            padding: 8px 15px;
            border-radius: 20px;
        }

        .panic-alert {
            background-color: #ff4d4d !important;
            color: white;
            animation: pulse-red 1s infinite;
        }

        @keyframes pulse-red {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        #img-camera {
            width: 100%;
            border-radius: 8px;
            border: 2px solid #ddd;
            min-height: 200px;
            object-fit: cover;
        }

        .timestamp {
            font-size: 0.75rem;
            color: #6c757d;
            display: block;
        }
    </style>
</head>

<body>
    <!-- Formato de la pagina -->
    <div class="container dashboard-container">
        <header class="d-flex justify-content-between align-items-center mb-4 px-3">
            <div>
                <h1 class="h3 fw-bold mb-0">Monitor del Paciente <span class="text-primary">ITL</span></h1>
                <small class="text-muted">Sistema de Rastreo y Emergencia</small>
            </div>
            <div id="conn-status" class="status-badge bg-warning text-dark">
                <i class="bi bi-broadcast"></i> Conectando...
            </div>
        </header>

        <div class="row g-4">
            <div class="col-lg-8">
                <div id="map" class="mb-4"></div>

                <div class="card card-custom p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold m-0"><i class="bi bi-geo-alt-fill text-primary"></i> Per칤metro Seguro</h5>
                        <div id="active-zone" class="badge bg-light text-dark border p-2">
                            Zona Actual: <span id="cur-lat">--</span>, <span id="cur-lon">--</span> (<span
                                id="cur-range">--</span>m)
                        </div>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-4">
                            <input type="number" id="cfg-lat" class="form-control" placeholder="Latitud segura"
                                step="any">
                        </div>
                        <div class="col-md-4">
                            <input type="number" id="cfg-lon" class="form-control" placeholder="Longitud segura"
                                step="any">
                        </div>
                        <div class="col-md-2">
                            <input type="number" id="cfg-range" class="form-control" placeholder="Rango (m)">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="enviarConfigGPS()">Guardar</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div id="panic-card" class="card card-custom mb-3 p-3 text-center bg-white">
                    <h6 class="text-muted small fw-bold">ESTADO DE P츼NICO</h6>
                    <h3 id="panic-text" class="fw-bold m-0">SEGURO</h3>
                    <span id="panic-time" class="timestamp mt-1">Esperando datos...</span>
                </div>

                <div class="card card-custom mb-3 p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-muted small fw-bold m-0">BATER칈A</h6>
                        <span id="battery-time" class="timestamp">Sin datos</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <h2 id="txt-battery" class="me-3 mb-0">--%</h2>
                        <div class="progress flex-grow-1" style="height: 12px;">
                            <div id="bar-battery" class="progress-bar bg-success" role="progressbar" style="width: 0%">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card card-custom mb-3 p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-muted small fw-bold m-0">UBICACI칍N GPS</h6>
                        <span id="gps-time" class="timestamp">Sin datos</span>
                    </div>
                    <p class="mb-1"><strong>Lat:</strong> <span id="txt-lat">0.000000</span></p>
                    <p class="mb-0"><strong>Lon:</strong> <span id="txt-lon">0.000000</span></p>
                </div>

                <div class="card card-custom mb-3 p-3">
                    <h6 class="text-muted small fw-bold mb-2">칔LTIMA FOTO RECIBIDA</h6>
                    <img id="img-camera" src="https://via.placeholder.com/400x300?text=Esperando+Captura..."
                        alt="C치mara">
                </div>

                <div class="card card-custom p-3">
                    <button id="btn-alarm" class="btn btn-danger btn-lg w-100 py-3 fw-bold" onclick="toggleAlarma()">
                        <i class="bi bi-megaphone-fill me-2"></i> ENCENDER ALARMA
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 1. CONFIGURACI칍N MQTT
        const MQTT_CONFIG = {
            host: "2e0044525b804543a6fe6ab2fcadfa2f.s1.eu.hivemq.cloud",
            port: 8884,
            user: "Rizo_",
            pass: "Rizo1234",
            clientId: "MonitorWeb_" + Math.random().toString(16).substr(2, 6)
        };

        let alarmaEncendida = false;

        // 2. CONFIGURACI칍N DE MAPA E ICONOS
        const map = L.map('map').setView([21.1190, -101.6964], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // Icono Verde para el Punto Seguro
        const greenIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        // Marcadores Globales
        let patientMarker = L.marker([21.1190, -101.6964]).addTo(map).bindPopup("Paciente");
        let safeMarker = null;
        let safeCircle = null;

        // 3. CONEXI칍N MQTT
        const client = new Paho.MQTT.Client("wss://" + MQTT_CONFIG.host + ":" + MQTT_CONFIG.port + "/mqtt", MQTT_CONFIG.clientId);

        client.onConnectionLost = (resp) => {
            const badge = document.getElementById('conn-status');
            badge.innerText = "游댮 Desconectado";
            badge.className = "status-badge bg-danger text-white";
        };

        client.onMessageArrived = (message) => {
            const topic = message.destinationName;
            const payload = message.payloadString;

            if (topic === "brazalete/datos") {
                actualizarDatos(JSON.parse(payload));
            } else if (topic === "brazalete/gps") {
                actualizarGPS(JSON.parse(payload));
            } else if (topic === "brazalete/camara") {
                actualizarFoto(payload);
            } else if (topic === "brazalete/zona_segura") {
                actualizarZonaActiva(JSON.parse(payload));
            }
        };

        function conectar() {
            client.connect({
                onSuccess: () => {
                    const badge = document.getElementById('conn-status');
                    badge.innerText = "游릭 Conectado";
                    badge.className = "status-badge bg-success text-white";
                    client.subscribe("brazalete/datos");
                    client.subscribe("brazalete/gps");
                    client.subscribe("brazalete/camara");
                    client.subscribe("brazalete/zona_segura");
                },
                onFailure: (e) => {
                    const badge = document.getElementById('conn-status');
                    badge.innerText = "游댮 Error de Conexi칩n";
                    badge.className = "status-badge bg-danger text-white";
                },
                useSSL: true, userName: MQTT_CONFIG.user, password: MQTT_CONFIG.pass
            });
        }

        // 4. FUNCIONES DE ACTUALIZACI칍N DIN츼MICA

        function actualizarZonaActiva(data) {
            const coords = [data.lat, data.lon];
            const radio = data.rango;

            // Actualizar textos
            document.getElementById('cur-lat').innerText = data.lat.toFixed(4);
            document.getElementById('cur-lon').innerText = data.lon.toFixed(4);
            document.getElementById('cur-range').innerText = radio;

            // Actualizar C칤rculo (Crear si no existe, mover si ya existe)
            if (safeCircle) {
                safeCircle.setLatLng(coords);
                safeCircle.setRadius(radio);
            } else {
                safeCircle = L.circle(coords, {
                    color: '#28a745', fillColor: '#28a745', fillOpacity: 0.2, radius: radio
                }).addTo(map);
            }

            // Actualizar Marcador Verde
            if (safeMarker) {
                safeMarker.setLatLng(coords);
            } else {
                safeMarker = L.marker(coords, { icon: greenIcon }).addTo(map).bindPopup("Punto Seguro");
            }

            // Auto-Ajuste de C치mara para mostrar todo el escenario
            const bounds = new L.featureGroup([patientMarker, safeCircle]);
            map.fitBounds(bounds.getBounds(), { padding: [50, 50] });

            // Efecto visual en el badge
            const badge = document.getElementById('active-zone');
            badge.className = "badge bg-success text-white border p-2";
            setTimeout(() => { badge.className = "badge bg-light text-dark border p-2"; }, 2000);
        }

        function actualizarGPS(data) {
            const coords = [data.lat, data.lon];
            patientMarker.setLatLng(coords);

            // Si no hay zona segura definida a칰n, seguimos al paciente
            if (!safeCircle) {
                map.panTo(coords);
            }

            document.getElementById('txt-lat').innerText = data.lat.toFixed(6);
            document.getElementById('txt-lon').innerText = data.lon.toFixed(6);
            document.getElementById('gps-time').innerText = data.fecha;

            // Si existe zona, mostramos si est치 dentro o fuera
            if (data.hasOwnProperty('zona')) {
                const timeSpan = document.getElementById('gps-time');
                const statusLabel = data.zona ?
                    '<span class="text-success fw-bold ms-2">(DENTRO)</span>' :
                    '<span class="text-danger fw-bold ms-2">(FUERA)</span>';
                timeSpan.innerHTML = data.fecha + statusLabel;
            }
        }

        function actualizarDatos(data) {
            document.getElementById('txt-battery').innerText = data.bateria + "%";
            document.getElementById('bar-battery').style.width = data.bateria + "%";
            const ahora = new Date().toLocaleTimeString();
            document.getElementById('battery-time').innerText = "Hoy, " + ahora;

            const panicCard = document.getElementById('panic-card');
            if (data.panico) {
                panicCard.className = "card card-custom mb-3 p-3 text-center panic-alert";
                document.getElementById('panic-text').innerText = "춰EMERGENCIA!";
                document.getElementById('panic-time').innerText = "Activado: " + ahora;
            } else {
                panicCard.className = "card card-custom mb-3 p-3 text-center bg-white";
                document.getElementById('panic-text').innerText = "SEGURO";
                document.getElementById('panic-time').innerText = "칔ltimo reporte: " + ahora;
            }
        }

        function actualizarFoto(base64) {
            document.getElementById('img-camera').src = "data:image/jpeg;base64," + base64.trim();
        }

        // 5. ACCIONES
        function toggleAlarma() {
            const btn = document.getElementById('btn-alarm');
            let comando = !alarmaEncendida ? "buzzer_on" : "buzzer_off";
            alarmaEncendida = !alarmaEncendida;

            // Actualizar interfaz del bot칩n
            btn.innerHTML = alarmaEncendida ?
                '<i class="bi bi-megaphone-fill me-2"></i> APAGAR ALARMA' :
                '<i class="bi bi-megaphone-fill me-2"></i> ENCENDER ALARMA';

            btn.className = alarmaEncendida ?
                "btn btn-secondary btn-lg w-100 py-3 fw-bold" :
                "btn btn-danger btn-lg w-100 py-3 fw-bold";

            const message = new Paho.MQTT.Message(comando);
            message.destinationName = "brazalete/comandos";

            // Enviar mensaje
            client.send(message);

            console.log("MQTT: Enviando comando -> " + comando);
        }

        function enviarConfigGPS() {
            const lat = parseFloat(document.getElementById('cfg-lat').value);
            const lon = parseFloat(document.getElementById('cfg-lon').value);
            const range = parseInt(document.getElementById('cfg-range').value);

            if (isNaN(lat) || isNaN(lon) || isNaN(range)) {
                alert("Por favor, llena todos los campos num칠ricos.");
                return;
            }

            const payload = JSON.stringify({ lat: lat, lon: lon, rango: range });
            const message = new Paho.MQTT.Message(payload);
            message.destinationName = "brazalete/config";
            client.send(message);
        }

        window.onload = conectar;
    </script>

</body>

</html>